<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SR Truck Quote Builder</title>

  <script>
  // === Row Insertion & Deletion ===
  function insertRow(btn) {
    const row = btn.closest('tr');
    const newRow = document.createElement('tr');
    newRow.setAttribute('draggable', 'true');
    newRow.innerHTML = `
      <td contenteditable="true" placeholder="Enter description..."></td>
      <td contenteditable="true" onblur="formatCurrency(this)" oninput="updateTotal()" placeholder="Enter amount..."></td>
      <td class="actions">
        <button class="action-btn add" onclick="insertRow(this)">+</button>
        <button class="action-btn delete" onclick="deleteRow(this)">ðŸ—‘</button>
      </td>
    `;
    row.parentNode.insertBefore(newRow, row.nextSibling);
    addDragEvents(newRow);
  }

  function deleteRow(btn) {
    const row = btn.closest('tr');
    const tbody = document.getElementById('quoteBody');
    if (tbody.rows.length > 1) {
      row.remove();
      updateTotal();
    } else {
      row.querySelectorAll('td[contenteditable="true"]').forEach(td => td.innerHTML = '');
      updateTotal();
    }
  }

  // === Currency Formatting & Totals ===
  function formatCurrency(cell) {
    const raw = cell.innerText.replace(/[^0-9.]/g, '');
    const num = parseFloat(raw);
    if (!isNaN(num)) {
      cell.innerText = num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
    } else {
      cell.innerText = '';
    }
    updateTotal();
  }

  function updateTotal() {
    const rows = document.querySelectorAll("#quoteBody tr");
    let total = 0;
    rows.forEach(row => {
      const amountCell = row.querySelectorAll("td")[1];
      if (amountCell) {
        const amount = parseFloat(amountCell.innerText.replace(/[^0-9.-]+/g, ""));
        if (!isNaN(amount)) total += amount;
      }
    });
    document.getElementById("grandTotal").innerText = total.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD'
    });
  }

  // === Copy Quote Text ===
  function copyQuote() {
    const rows = document.querySelectorAll("#quoteBody tr");
    let quoteText = "=== SR Truck Quote ===\n\n";
    quoteText += "Description of Work to be Performed | Total $\n";
    quoteText += "------------------------------------|---------\n";

    rows.forEach(row => {
      const cells = row.querySelectorAll("td");
      const desc = (cells[0].innerHTML || "").replace(/<[^>]*>/g, '').trim();
      const total = (cells[1].innerText || "").trim();
      if (desc || total) {
        quoteText += `${desc} | ${total}\n`;
      }
    });

    const grandTotal = document.getElementById("grandTotal").innerText;
    quoteText += `\nTOTAL AMOUNT: ${grandTotal}\n`;
    quoteText += "\n----------------------\nThank you for choosing SR Truck!";

    navigator.clipboard.writeText(quoteText).then(() => {
      const msg = document.getElementById("message");
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 3000);
    });
  }

  // === Drag and Drop Reordering ===
  let dragSrcRow = null;

  function addDragEvents(row) {
    row.addEventListener('dragstart', (e) => {
      dragSrcRow = row;
      row.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });

    row.addEventListener('dragend', () => {
      row.classList.remove('dragging');
      updateTotal();
    });

    row.addEventListener('dragover', (e) => {
      e.preventDefault();
      const tbody = row.parentNode;
      const draggingRow = document.querySelector('.dragging');
      const rows = [...tbody.querySelectorAll('tr')];
      const nextRow = rows.find(r => e.clientY <= r.offsetTop + r.offsetHeight / 2);
      tbody.insertBefore(draggingRow, nextRow);
    });
  }

  // === Initialize on Load ===
  document.querySelectorAll('#quoteBody tr').forEach(addDragEvents);
</script>

</head>

<body>
  <div class="container">
    <h1>SR Truck Quote Builder</h1>

    <table id="quoteTable">
      <thead>
        <tr>
          <th>Description of Work to be Performed</th>
          <th>Total $</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="quoteBody">
        <tr>
          <td contenteditable="true" placeholder="Enter description..."></td>
          <td contenteditable="true" onblur="formatCurrency(this)" oninput="updateTotal()" placeholder="Enter amount..."></td>
          <td class="actions">
            <button class="action-btn add" onclick="insertRow(this)">+</button>
            <button class="action-btn delete" onclick="deleteRow(this)">ðŸ—‘</button>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td style="text-align:right;">Total Amount:</td>
          <td id="grandTotal">$0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <button type="button" onclick="copyQuote()">ðŸ“‹ Copy Quote</button>
    <div id="message">Quote copied â€” paste it into Striven!</div>
  </div>

  <script>
    function insertRow(btn) {
      const row = btn.closest('tr');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td contenteditable="true" placeholder="Enter description..."></td>
        <td contenteditable="true" onblur="formatCurrency(this)" oninput="updateTotal()" placeholder="Enter amount..."></td>
        <td class="actions">
          <button class="action-btn add" onclick="insertRow(this)">+</button>
          <button class="action-btn delete" onclick="deleteRow(this)">ðŸ—‘</button>
        </td>
      `;
      row.parentNode.insertBefore(newRow, row.nextSibling);
    }

    function deleteRow(btn) {
      const row = btn.closest('tr');
      const tbody = document.getElementById('quoteBody');
      if (tbody.rows.length > 1) {
        row.remove();
        updateTotal();
      } else {
        // Clear last row instead of deleting it
        row.querySelectorAll('td[contenteditable="true"]').forEach(td => td.innerHTML = '');
        updateTotal();
      }
    }

    function formatCurrency(cell) {
      const raw = cell.innerText.replace(/[^0-9.]/g, '');
      const num = parseFloat(raw);
      if (!isNaN(num)) {
        cell.innerText = num.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD'
        });
      } else {
        cell.innerText = '';
      }
      updateTotal();
    }

    function updateTotal() {
      const rows = document.querySelectorAll("#quoteBody tr");
      let total = 0;
      rows.forEach(row => {
        const amountCell = row.querySelectorAll("td")[1];
        if (amountCell) {
          const amount = parseFloat(amountCell.innerText.replace(/[^0-9.-]+/g, ""));
          if (!isNaN(amount)) total += amount;
        }
      });
      document.getElementById("grandTotal").innerText = total.toLocaleString('en-US', {
        style: 'currency',
        currency: 'USD'
      });
    }

    function copyQuote() {
      const rows = document.querySelectorAll("#quoteBody tr");
      let quoteText = "=== SR Truck Quote ===\n\n";
      quoteText += "Description of Work to be Performed | Total $\n";
      quoteText += "------------------------------------|---------\n";

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const desc = (cells[0].innerHTML || "").replace(/<[^>]*>/g, '').trim();
        const total = (cells[1].innerText || "").trim();
        if (desc || total) {
          quoteText += `${desc} | ${total}\n`;
        }
      });

      const grandTotal = document.getElementById("grandTotal").innerText;
      quoteText += `\nTOTAL AMOUNT: ${grandTotal}\n`;
      quoteText += "\n----------------------\nThank you for choosing SR Truck!";

      navigator.clipboard.writeText(quoteText).then(() => {
        const msg = document.getElementById("message");
        msg.style.display = "block";
        setTimeout(() => msg.style.display = "none", 3000);
      });
    }
  </script>
</body>
</html>
